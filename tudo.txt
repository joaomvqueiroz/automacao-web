#!/bin/bash

# =================================================================
# Script 1: Instala√ß√£o dos Servi√ßos Principais (LAMP Stack Base)
# Objetivo: Instalar Apache, PHP (8.x) e MariaDB, ativar servi√ßos
# e criar ficheiro de valida√ß√£o info.php.
# =================================================================

# Cores para feedback visual
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

IP_SIMULADO="192.168.1.10" # Baseado no valor IPADDR do relat√≥rio

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Instala√ß√£o da Stack LAMP Base no CentOS Stream 9 ---${NC}"

# --- 1. Atualiza√ß√£o e Reposit√≥rios Essenciais ---
log_info "1. Atualiza√ß√£o e Reposit√≥rio EPEL"
echo ">> A instalar o reposit√≥rio EPEL e atualizar o sistema..."
sudo dnf install epel-release -y 
sudo dnf update -y
echo -e "${GREEN}‚úîÔ∏è Reposit√≥rios prontos.${NC}"
echo "--------------------------------------------------------"

# --- 2. Instala√ß√£o e Ativa√ß√£o do Apache (HTTPD) ---
log_info "2. Instala√ß√£o e Verifica√ß√£o do Servidor Apache (HTTPD)"
echo ">> A instalar o Apache (httpd) e o m√≥dulo SSL (mod_ssl)..."
sudo dnf install httpd mod_ssl -y

echo ">> A ativar e iniciar o servi√ßo httpd..."
sudo systemctl enable httpd
sudo systemctl start httpd

if sudo systemctl is-active httpd &> /dev/null; then
    echo -e "${GREEN}‚úîÔ∏è Apache ativo e em execu√ß√£o.${NC}"
else
    echo -e "${RED}‚ùå ERRO: Falha ao iniciar o Apache. Verifique o estado: 'sudo systemctl status httpd'.${NC}"
    exit 1
fi
echo "--------------------------------------------------------"

# --- 3. Instala√ß√£o e Configura√ß√£o do PHP (8.x) ---
log_info "3. Instala√ß√£o e Verifica√ß√£o do PHP (Vers√£o 8.x)"

# Configura√ß√£o do m√≥dulo PHP 8.3 (seguindo o relat√≥rio)
echo ">> A instalar o reposit√≥rio Remi e a preparar o PHP 8.3..."
sudo dnf install https://rpms.remirepo.net/enterprise/remi-release-9.rpm -y
sudo dnf module reset php -y
sudo dnf module enable php:8.3 -y 
echo ">> A instalar o PHP e m√≥dulos essenciais (php-mysqlnd, php-cli, etc.)..."
sudo dnf install php php-cli php-fpm php-mysqlnd php-gd php-xml php-json php-mbstring -y

echo -e "${GREEN}‚úîÔ∏è PHP $(php -v | head -n 1) instalado.${NC}"
echo "--------------------------------------------------------"

# --- 4. Instala√ß√£o e Ativa√ß√£o do MariaDB ---
log_info "4. Instala√ß√£o e Ativa√ß√£o do MariaDB Server"
echo ">> A instalar o MariaDB..."
sudo dnf install mariadb-server -y

echo ">> A ativar e iniciar o servi√ßo mariadb..."
sudo systemctl enable mariadb
sudo systemctl start mariadb

if sudo systemctl is-active mariadb &> /dev/null; then
    echo -e "${GREEN}‚úîÔ∏è MariaDB ativo e em execu√ß√£o.${NC}"
else
    echo -e "${RED}‚ùå ERRO: Falha ao iniciar o MariaDB. Verifique o estado: 'sudo systemctl status mariadb'.${NC}"
    exit 1
fi
echo "--------------------------------------------------------"

# --- 5. Cria√ß√£o do Ficheiro de Teste (info.php) ---
log_info "5. Cria√ß√£o e Valida√ß√£o do Ficheiro info.php"
echo ">> A criar o ficheiro /var/www/html/info.php para teste..."
echo '<?php phpinfo(); ?>' | sudo tee /var/www/html/info.php > /dev/null

echo ">> A reiniciar o Apache para carregar as configura√ß√µes do PHP..."
sudo systemctl restart httpd

# --- 6. Valida√ß√£o ---
echo -e "\n${YELLOW}--- ‚úÖ Instala√ß√£o e Ativa√ß√£o Conclu√≠das ---${NC}"
echo -e "${GREEN}Status dos Servi√ßos:${NC}"
echo "Apache: $(sudo systemctl is-active httpd)"
echo "MariaDB: $(sudo systemctl is-active mariadb)"
echo "PHP Vers√£o: $(php -v | head -n 1)"
echo -e "${GREEN}Pode verificar a acessibilidade no browser atrav√©s do IP simulado (${IP_SIMULADO}/info.php).${NC}"
echo "--------------------------------------------------------"


#!/bin/bash

# =================================================================
# Script 2: Configura√ß√£o Segura do MariaDB
# Objetivo: Executar a rotina de seguran√ßa interativa do MariaDB.
# =================================================================

# Cores para feedback visual
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Configura√ß√£o Segura do MariaDB ---${NC}"

# 1. Verificar o Servi√ßo MariaDB
echo -e "${YELLOW}>> 1. Verificando se o servi√ßo MariaDB est√° ativo...${NC}"

if ! sudo systemctl is-active mariadb &> /dev/null; then
    echo -e "${RED}‚ùå ERRO: O servi√ßo MariaDB n√£o est√° ativo. Por favor, inicie-o com 'sudo systemctl start mariadb'. A sair.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úîÔ∏è Servi√ßo MariaDB ativo.${NC}"

# 2. Executar Configura√ß√£o de Seguran√ßa Inicial (Interativa)
echo -e "\n${YELLOW}>> 2. INICIANDO O UTILIT√ÅRIO DE SEGURAN√áA (mysql_secure_installation)...${NC}"
echo -e "${YELLOW}!!! ATEN√á√ÉO: Este passo √© INTERATIVO e requer a sua interven√ß√£o para:${NC}"
echo -e "${YELLOW}    - Definir a password 'root' do MariaDB.${NC}"
echo -e "${YELLOW}    - Remover utilizadores an√≥nimos e bases de dados de teste.${NC}"
echo -e "${YELLOW}    - Desativar o login 'root' remoto.${NC}"
echo "--------------------------------------------------------"

# Executar o utilit√°rio de seguran√ßa, que tamb√©m recarrega os privil√©gios no final.
sudo mysql_secure_installation

if [ $? -eq 0 ]; then
    echo -e "\n${GREEN}üéâ Configura√ß√£o de seguran√ßa inicial conclu√≠da!${NC}"
else
    echo -e "\n${RED}‚ö†Ô∏è A execu√ß√£o de 'mysql_secure_installation' terminou com um erro. Reveja a seguran√ßa do seu MariaDB.${NC}"
fi

echo -e "\n${YELLOW}--- ‚úÖ Script de Configura√ß√£o Segura do MariaDB Conclu√≠do ---${NC}"



#!/bin/bash
# =================================================================
# Script 3: Configura√ß√£o de Rede e Firewall (NMCLI, Firewalld & IP P√∫blico)
# Objetivo: Configurar IP Est√°tico, abrir portas essenciais no Firewalld
#           e testar a conectividade externa (Ping, Curl e DuckDNS opcional)
# Compat√≠vel com: CentOS 7, 8, 9, Stream e 10
# =================================================================

# --- Cores ---
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# --- Fun√ß√µes auxiliares ---
log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

check_command() {
    command -v "$1" >/dev/null 2>&1
}

# =================================================================
echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Configura√ß√£o de Rede e Seguran√ßa ---${NC}"

# --- 1. Configura√ß√£o de IP Est√°tico ---
log_info "1. Configura√ß√£o da Placa de Rede (IP Est√°tico via NMCLI)"

echo -e "${BLUE}Interfaces de rede dispon√≠veis:${NC}"
nmcli device status | grep -E "ethernet|wifi"
echo

read -p "Digite o nome da interface de rede/conex√£o (ex: ens33): " NET_IFACE
CONN_NAME="$NET_IFACE"

CONN_EXISTS=$(nmcli connection show | grep -w "$CONN_NAME" | wc -l)

if [ "$CONN_EXISTS" -eq 0 ]; then
    log_info "Conex√£o '$CONN_NAME' n√£o encontrada. Criando nova..."
    sudo nmcli connection add type ethernet con-name "$CONN_NAME" ifname "$NET_IFACE"
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå ERRO: Falha ao criar a conex√£o '$CONN_NAME'.${NC}"
        exit 1
    fi
else
    log_info "Conex√£o '$CONN_NAME' encontrada. Modificando configura√ß√£o existente."
fi

# --- Dados de rede ---
read -p "Digite o IP do servidor (CIDR, ex: 192.168.1.10/24): " IP_CIDR
read -p "Digite o gateway padr√£o (ex: 192.168.1.254): " GATEWAY
read -p "Digite o servidor DNS principal (ex: 8.8.8.8): " DNS_SERVER

# --- Aplicar configura√ß√£o ---
log_info "Aplicando configura√ß√µes est√°ticas..."
sudo nmcli connection modify "$CONN_NAME" ipv4.method manual ipv4.addresses "$IP_CIDR" ipv4.gateway "$GATEWAY" ipv4.dns "$DNS_SERVER" connection.autoconnect yes

log_info "Reativando a conex√£o ${CONN_NAME}..."
sudo nmcli connection down "$CONN_NAME" >/dev/null 2>&1
sudo nmcli connection up "$CONN_NAME" >/dev/null 2>&1
sleep 2

if ip addr show "$NET_IFACE" | grep -q "${IP_CIDR%/*}"; then
    echo -e "${GREEN}‚úîÔ∏è IP est√°tico configurado com sucesso.${NC}"
else
    echo -e "${RED}‚ùå ERRO: Falha ao aplicar IP est√°tico.${NC}"
fi
echo "--------------------------------------------------------"

# =================================================================
# --- 2. Configura√ß√£o do Firewalld ---
log_info "2. Configura√ß√£o do Firewall (Firewalld)"

if ! systemctl is-active firewalld &>/dev/null; then
    echo ">> Firewalld n√£o est√° ativo. Iniciando servi√ßo..."
    sudo systemctl enable --now firewalld
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå ERRO: Falha ao iniciar o firewalld.${NC}"
        exit 1
    fi
fi

echo ">> Limpando e abrindo apenas as portas essenciais (22, 80, 443)..."
sudo firewall-cmd --permanent --remove-service=ssh >/dev/null 2>&1
sudo firewall-cmd --permanent --remove-service=http >/dev/null 2>&1
sudo firewall-cmd --permanent --remove-service=https >/dev/null 2>&1
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úîÔ∏è Regras do firewall aplicadas com sucesso.${NC}"
    echo "Regras ativas:"
    sudo firewall-cmd --list-services
else
    echo -e "${RED}‚ùå ERRO: Falha ao aplicar regras do firewall.${NC}"
fi
echo "--------------------------------------------------------"

# =================================================================
# --- 3. Verifica√ß√£o de IP P√∫blico e Conectividade ---
log_info "3. Verifica√ß√£o de Conectividade Externa (Ping e Curl)"

# --- IP p√∫blico ---
echo ">> Obtendo IP p√∫blico (via ifconfig.me)..."
PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)
if [ -n "$PUBLIC_IP" ]; then
    echo -e "IP P√∫blico Detetado: ${YELLOW}${PUBLIC_IP}${NC}"
else
    echo -e "${RED}‚ö†Ô∏è N√£o foi poss√≠vel obter o IP p√∫blico.${NC}"
fi

# --- Teste de conectividade ---
echo ">> Testando ping (google.com)..."
if ping -c 3 google.com &>/dev/null; then
    echo -e "${GREEN}‚úîÔ∏è Conectividade externa OK (Ping).${NC}"
else
    echo -e "${RED}‚ùå Falha no ping para a Internet.${NC}"
fi
echo "--------------------------------------------------------"

# =================================================================
# --- 4. Configura√ß√£o opcional de Redirecionamento (DuckDNS) ---
log_info "4. Configura√ß√£o do DuckDNS (Redirecionamento din√¢mico opcional)"

read -p "Deseja configurar o DuckDNS e agendamento via cron? (s/n): " duck_response

if [[ "$duck_response" =~ ^[Ss]$ ]]; then
    if check_command curl && check_command crontab; then
        read -p "Digite o seu subdom√≠nio DuckDNS (ex: meuservidor): " DUCK_DOMAIN
        read -p "Digite o seu token DuckDNS: " DUCK_TOKEN

        echo ">> Criando diret√≥rio e script do DuckDNS..."
        sudo mkdir -p /root/duckdns
        sudo chmod 700 /root/duckdns

        cat <<EOF | sudo tee /root/duckdns/duck.sh >/dev/null



#!/bin/bash

# =================================================================
# Script 4: SELinux e Pol√≠ticas de Seguran√ßa (Auditoria e Relat√≥rio)
# Objetivo: Confirmar SELinux em enforcing, gerar relat√≥rio de alertas
# de auditoria e criar um log centralizado.
# =================================================================

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SELINUX_REPORT_FILE="/var/log/seguranca.log"
AUDIT_LOG="/var/log/audit/audit.log"

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Auditoria de SELinux e Seguran√ßa ---${NC}"

# --- 1. Confirma√ß√£o do Estado do SELinux ---
log_info "1. Confirma√ß√£o do Modo SELinux"

CURRENT_SELINUX_MODE=$(getenforce)
echo ">> Estado atual do SELinux: ${YELLOW}$CURRENT_SELINUX_MODE${NC}"

if [ "$CURRENT_SELINUX_MODE" == "Enforcing" ]; then
    echo -e "${GREEN}‚úîÔ∏è SELinux est√° em modo 'Enforcing'.${NC}"
else
    echo -e "${RED}‚ö†Ô∏è AVISO: SELinux N√ÉO est√° em modo 'Enforcing'. Ajuste via 'sudo nano /etc/selinux/config' e reinicie.${NC}"
fi
echo "--------------------------------------------------------"

# --- 2. Gera√ß√£o de Relat√≥rios de Auditoria (sealert) ---
log_info "2. Gera√ß√£o de Relat√≥rios de Alertas de Auditoria (sealert)"

# Verifica se o auditd est√° ativo para ter certeza de que o ficheiro de log existe
if ! sudo systemctl is-active auditd &> /dev/null; then
    echo -e "${YELLOW}>> Servi√ßo 'auditd' inativo. Tentando iniciar para gerar o relat√≥rio.${NC}"
    sudo systemctl enable --now auditd
    sleep 2
fi

if [ -f "$AUDIT_LOG" ]; then
    echo ">> A gerar relat√≥rio de alertas de SELinux a partir de $AUDIT_LOG..."
    
    # O comando sealert pode levar algum tempo; limitamos a sa√≠da para o terminal.
    # O output completo √© direcionado para o log centralizado na pr√≥xima se√ß√£o.
    SELINUX_ALERT_OUTPUT=$(sudo sealert -a "$AUDIT_LOG" | head -n 10)
    
    if [ -n "$SELINUX_ALERT_OUTPUT" ]; then
        echo -e "${YELLOW}Primeiros alertas de SELinux encontrados (sa√≠da completa no log):${NC}"
        echo "$SELINUX_ALERT_OUTPUT"
        echo -e "${GREEN}‚úîÔ∏è Relat√≥rio de alertas gerado com sucesso.${NC}"
    else
        echo -e "${GREEN}‚úîÔ∏è Nenhum alerta recente de SELinux encontrado em $AUDIT_LOG.${NC}"
    fi
else
    echo -e "${RED}‚ùå ERRO: Ficheiro de log de auditoria $AUDIT_LOG n√£o encontrado. Instale e inicie o 'auditd'.${NC}"
fi
echo "--------------------------------------------------------"

# --- 3. Cria√ß√£o de Log Centralizado (/var/log/seguranca.log) ---
log_info "3. Cria√ß√£o e Preenchimento de Log Centralizado"

TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

echo ">> A criar/atualizar o log centralizado em $SELINUX_REPORT_FILE..."

# Cria o ficheiro de log se n√£o existir e adiciona um cabe√ßalho
if [ ! -f "$SELINUX_REPORT_FILE" ]; then
    echo "============================================================" | sudo tee "$SELINUX_REPORT_FILE" > /dev/null
    echo "LOG DE SEGURAN√áA E AUDITORIA - $TIMESTAMP" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
    echo "============================================================" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
else
    echo -e "\n\n=== RELAT√ìRIO DE SEGURAN√áA EXECUTADO EM $TIMESTAMP ===" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
fi

# Adiciona o estado do SELinux
echo "Estado do SELinux: $CURRENT_SELINUX_MODE" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null

# Adiciona o relat√≥rio completo de alertas de SELinux (se o ficheiro de audit existir)
if [ -f "$AUDIT_LOG" ]; then
    echo "--- Relat√≥rio sealert Completo ---" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
    sudo sealert -a "$AUDIT_LOG" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
    echo "--- Fim do Relat√≥rio sealert ---" | sudo tee -a "$SELINUX_REPORT_FILE" > /dev/null
fi

echo -e "${GREEN}‚úîÔ∏è Log de seguran√ßa centralizado atualizado em $SELINUX_REPORT_FILE.${NC}"
echo "--------------------------------------------------------"

echo -e "\n${YELLOW}--- ‚úÖ Script de Auditoria SELinux Conclu√≠do ---${NC}"




#!/bin/bash
echo url="https://www.duckdns.org/update?domains=${DUCK_DOMAIN}&token=${DUCK_TOKEN}&ip=" | curl -k -o /root/duckdns/duck.log -K -
DATA=$(date)
echo -e "\n\${DATA} OK" >> /root/duckdns/duck.log
EOF

        sudo chmod 700 /root/duckdns/duck.sh

        (sudo crontab -l 2>/dev/null; echo "*/5 * * * * /root/duckdns/duck.sh >/dev/null 2>&1") | sudo crontab -
        echo -e "${GREEN}‚úîÔ∏è DuckDNS configurado e agendado com sucesso para o dom√≠nio '${DUCK_DOMAIN}'.${NC}"
    else
        echo -e "${RED}‚ùå curl ou crontab n√£o est√£o instalados.${NC}"
    fi
else
    echo "DuckDNS ignorado."
fi

echo -e "\n${YELLOW}--- ‚úÖ Configura√ß√£o de Rede e Firewall conclu√≠da ---${NC}"
# =================================================================


#!/bin/bash

# =================================================================
# Script 5: Configura√ß√£o do Fail2ban (SSH e Apache)
# Objetivo: Instalar Fail2ban, definir pol√≠tica de bloqueio (maxretry=3, bantime=3600)
# e ativar os jails para prote√ß√£o contra for√ßa bruta.
# =================================================================

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

JAIL_CONF="/etc/fail2ban/jail.conf"
JAIL_LOCAL="/etc/fail2ban/jail.local"

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Instala√ß√£o e Configura√ß√£o do Fail2ban ---${NC}"

# 1. Instalar o Fail2ban
log_info "1. Instala√ß√£o do Fail2ban"
echo ">> A instalar o pacote Fail2ban..."
sudo dnf install fail2ban -y

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: A instala√ß√£o do Fail2ban falhou. A sair.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úîÔ∏è Fail2ban instalado com sucesso.${NC}"
echo "--------------------------------------------------------"

# 2. Criar Ficheiro de Configura√ß√£o Local
log_info "2. Cria√ß√£o do Ficheiro de Configura√ß√£o Local (jail.local)"
if [ ! -f "$JAIL_LOCAL" ]; then
    echo ">> A criar o ficheiro $JAIL_LOCAL a partir do template..."
    sudo cp "$JAIL_CONF" "$JAIL_LOCAL"
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå ERRO: Falha ao copiar jail.conf. Verifique as permiss√µes. A sair.${NC}"
        exit 1
    fi
    echo -e "${GREEN}‚úîÔ∏è Ficheiro $JAIL_LOCAL criado para personaliza√ß√£o.${NC}"
else
    echo ">> Ficheiro $JAIL_LOCAL j√° existe. Apenas a aplicar altera√ß√µes."
fi
echo "--------------------------------------------------------"

# 3. Ajustar Pol√≠ticas de Bloqueio (maxretry e bantime)
log_info "3. Ajuste de Pol√≠ticas Globais e Locais"

# Defini√ß√µes globais do relat√≥rio: maxretry = 3 e bantime = 3600 (1 hora)
echo ">> A definir maxretry=3 e bantime=3600 (1 hora) globalmente e para jails essenciais..."

# Usar 'sed' para substituir ou adicionar as configura√ß√µes globais (DEFAULT section)
sudo sed -i 's/^bantime.*$/bantime = 3600/' "$JAIL_LOCAL"
sudo sed -i 's/^maxretry.*$/maxretry = 3/' "$JAIL_LOCAL"

# Ativar o jail SSHD (ssh/sftp)
echo ">> A ativar o jail [sshd]..."
# Garante que 'enabled = true' est√° presente no bloco [sshd]
sudo sed -i '/^\[sshd\]/,/^maxretry/ { /^enabled/!b; s/.*/enabled = true/; t; :a; /enabled/!{ /^\s*$/i enabled = true
 } }' "$JAIL_LOCAL"

# Ativar o jail Apache-Auth (Autentica√ß√£o Web, ex: .htpasswd)
echo ">> A ativar o jail [apache-auth] (para prote√ß√£o de pain√©is administrativos)..."
# Garante que 'enabled = true' est√° presente no bloco [apache-auth]
sudo sed -i '/^\[apache-auth\]/,/^maxretry/ { /^enabled/!b; s/.*/enabled = true/; t; :a; /enabled/!{ /^\s*$/i enabled = true
 } }' "$JAIL_LOCAL"

# Configura√ß√£o de Email (Requer MTA, como Postfix, instalado)
echo ">> NOTA: A configura√ß√£o de envio de email depende da instala√ß√£o e configura√ß√£o de um MTA."
echo ">> Para receber alertas, defina 'destemail' e 'mta' no $JAIL_LOCAL."
# Exemplo: sudo sed -i 's/^destemail.*$/destemail = seu.email@dominio.com/' "$JAIL_LOCAL"

echo -e "${GREEN}‚úîÔ∏è Pol√≠ticas de seguran√ßa (maxretry=3, bantime=3600) e jails ativados.${NC}"
echo "--------------------------------------------------------"

# 4. Ativar e Iniciar o Servi√ßo
log_info "4. Ativa√ß√£o e In√≠cio do Servi√ßo"
echo ">> A iniciar e ativar o servi√ßo Fail2ban..."
sudo systemctl enable --now fail2ban

if sudo systemctl is-active fail2ban &> /dev/null; then
    echo -e "${GREEN}üéâ Servi√ßo Fail2ban ativo e a monitorizar os logs!${NC}"
    echo ">> Verifique o estado: sudo fail2ban-client status"
else
    echo -e "${RED}‚ùå ERRO: Falha ao iniciar o Fail2ban. Verifique os logs do systemd.${NC}"
fi

echo -e "\n${YELLOW}--- ‚úÖ Script de Configura√ß√£o do Fail2ban Conclu√≠do ---${NC}"


#!/bin/bash

# =================================================================
# Script 6: Configura√ß√£o do Web Application Firewall (ModSecurity e OWASP CRS)
# Objetivo: Instalar ModSecurity, carregar as regras OWASP CRS, e ativar o WAF.
# =================================================================

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

MODSEC_DIR="/etc/httpd/modsecurity-crs"
HTTPD_CONF_DIR="/etc/httpd"
MODSEC_CONF="$HTTPD_CONF_DIR/conf.d/mod_security.conf"
CRS_GIT_REPO="https://github.com/coreruleset/coreruleset.git"

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

check_command() {
    command -v "$1" >/dev/null 2>&1
}

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando a Configura√ß√£o do ModSecurity (WAF) ---${NC}"

# 1. Instalar o M√≥dulo ModSecurity para Apache
log_info "1. Instala√ß√£o do M√≥dulo ModSecurity"
echo ">> A instalar o pacote mod_security..."
sudo dnf install mod_security -y

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO: A instala√ß√£o do ModSecurity falhou. A sair.${NC}"
    exit 1
fi
echo -e "${GREEN}‚úîÔ∏è ModSecurity instalado com sucesso.${NC}"
echo "--------------------------------------------------------"

# 2. Instalar as Regras OWASP CRS
log_info "2. Instala√ß√£o e Configura√ß√£o das Regras OWASP CRS"

# Verifica se o git est√° instalado
if ! check_command git; then
    echo -e "${RED}‚ùå ERRO: O comando 'git' n√£o foi encontrado. Instale-o com 'sudo dnf install git -y' e tente novamente. A sair.${NC}"
    exit 1
fi

echo ">> A criar diret√≥rio de regras: $MODSEC_DIR"
sudo mkdir -p "$MODSEC_DIR"

# Navega para o diret√≥rio antes de clonar
cd "$MODSEC_DIR" || { echo -e "${RED}‚ùå ERRO: Falha ao mudar para o diret√≥rio $MODSEC_DIR. A sair.${NC}"; exit 1; }

echo ">> A clonar o reposit√≥rio OWASP CRS..."
sudo git clone "$CRS_GIT_REPO" .

# Remover o diret√≥rio vazio clonado
# O reposit√≥rio √© clonado diretamente para o diret√≥rio atual, ent√£o n√£o h√° 'coreruleset/' para remover.

# Copiar ficheiros de exclus√£o de exemplo (essencial para evitar erros)
echo ">> A criar o ficheiro de configura√ß√£o principal do CRS (crs-setup.conf)..."
sudo cp crs-setup.conf.example crs-setup.conf

echo ">> A copiar ficheiros de exclus√£o de regras de exemplo..."
sudo cp rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf.example rules/REQUEST-900-EXCLUSION-RULES-BEFORE-CRS.conf
sudo cp rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf.example rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf

echo -e "${GREEN}‚úîÔ∏è Regras OWASP CRS instaladas em $MODSEC_DIR.${NC}"
# Retorna ao diret√≥rio original
cd - > /dev/null
echo "--------------------------------------------------------"

# 3. Ativar e Configurar o ModSecurity no Apache
log_info "3. Ativa√ß√£o do WAF (Web Application Firewall)"

# A. Configurar mod_security.conf
echo ">> A configurar $MODSEC_CONF..."

# Garante que SecRuleEngine est√° On
sudo sed -i 's/^SecRuleEngine DetectionOnly/SecRuleEngine On/' "$MODSEC_CONF"
sudo sed -i '/^SecRuleEngine/!b; s/.*/SecRuleEngine On/' "$MODSEC_CONF" # Fallback if line is different

# Adiciona SecRequestBodyAccess On se n√£o existir
if ! grep -q "SecRequestBodyAccess On" "$MODSEC_CONF"; then
    echo "SecRequestBodyAccess On" | sudo tee -a "$MODSEC_CONF" > /dev/null
fi

# Adiciona configura√ß√µes de auditoria
if ! grep -q "SecAuditEngine RelevantOnly" "$MODSEC_CONF"; then
    echo "SecAuditEngine RelevantOnly" | sudo tee -a "$MODSEC_CONF" > /dev/null
    echo "SecAuditLogRelevantStatus \"^(?:5|4(?!04))\"" | sudo tee -a "$MODSEC_CONF" > /dev/null
    echo "SecAuditLogType Concurrent" | sudo tee -a "$MODSEC_CONF" > /dev/null
    echo "SecAuditLog /var/log/httpd/modsec_audit.log" | sudo tee -a "$MODSEC_CONF" > /dev/null
fi

# B. Adicionar includes para carregar as regras no mod_security.conf
echo ">> A adicionar includes das regras OWASP CRS..."

# Remove includes antigos para evitar duplica√ß√£o
sudo sed -i '/IncludeOptional .*modsecurity-crs\/crs-setup.conf/d' "$MODSEC_CONF"
sudo sed -i '/IncludeOptional .*modsecurity-crs\/rules\/\*.conf/d' "$MODSEC_CONF"

# Adiciona os includes no final do ficheiro
echo -e "\nIncludeOptional $MODSEC_DIR/crs-setup.conf" | sudo tee -a "$MODSEC_CONF" > /dev/null
echo -e "IncludeOptional $MODSEC_DIR/rules/*.conf" | sudo tee -a "$MODSEC_CONF" > /dev/null

# C. Configurar crs-setup.conf para modo de preven√ß√£o
echo ">> A configurar $MODSEC_DIR/crs-setup.conf para modo de preven√ß√£o..."
sudo sed -i 's/^SecRuleEngine DetectionOnly/SecRuleEngine On/' "$MODSEC_DIR/crs-setup.conf"
sudo sed -i 's/^#SecRuleEngine On/SecRuleEngine On/' "$MODSEC_DIR/crs-setup.conf" # Caso esteja comentado

echo -e "${GREEN}‚úîÔ∏è ModSecurity configurado para o modo ativo (SecRuleEngine On).${NC}"
echo "--------------------------------------------------------"

# 4. Reiniciar o Apache e Testar
log_info "4. Valida√ß√£o e Rein√≠cio do Apache"
echo ">> A reiniciar o Apache para aplicar o WAF..."
sudo systemctl restart httpd

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úîÔ∏è Apache reiniciado com sucesso. ModSecurity deve estar ativo.${NC}"
    
    # Teste Simulado (Baseado no seu relat√≥rio)
    echo -e "\n${YELLOW}>> TESTE DE PROTE√á√ÉO SIMULADO (Tentativa de XSS):${NC}"
    echo "   (Resultado esperado: HTTP 403 Forbidden)"
    
    # Usar o curl para simular um ataque XSS no par√¢metro 'q'
    # Isto simula o teste do relat√≥rio: curl -I "http://127.0.0.1/?q=<script>alert(1)</script>"
    CURL_TEST=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1/?q=<script>alert(1)</script>")

    if [ "$CURL_TEST" == "403" ]; then
        echo -e "${GREEN}üéâ TESTE BEM-SUCEDIDO: O WAF bloqueou o ataque (C√≥digo HTTP 403 Forbidden).${NC}"
    else
        echo -e "${RED}‚ùå TESTE FALHOU: O c√≥digo HTTP retornado foi $CURL_TEST. O WAF pode n√£o estar a funcionar corretamente.${NC}"
    fi
else
    echo -e "${RED}‚ùå ERRO: Falha ao reiniciar o Apache. Verifique a sintaxe da configura√ß√£o do ModSecurity (sudo apachectl configtest).${NC}"
fi

echo -e "\n${YELLOW}--- ‚úÖ Script de Configura√ß√£o do ModSecurity Conclu√≠do ---${NC}"



#!/bin/bash
# ===================================================================
# Script 7: Tuning do Apache (Compress√£o, Timeouts e MPM)
# Objetivo: Aplicar ajustes de performance baseados no hardware (RAM/CPU)
# e configurar o MPM Event.
# ===================================================================

# Cores para feedback visual
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONF_FILE="/etc/httpd/conf/httpd.conf"
MODS_DIR="/etc/httpd/conf.modules.d"
MPM_CONF="/etc/httpd/conf.modules.d/00-mpm.conf"

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

echo -e "${YELLOW}--- üõ†Ô∏è Iniciando o Tuning Din√¢mico do Apache HTTPD ---${NC}"

# 1. Verifica√ß√µes e Instala√ß√£o do Apache
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}‚ö†Ô∏è Este script deve ser executado como root!${NC}"
    exit 1
fi

if ! command -v httpd &> /dev/null; then
    echo "‚ùå Apache (httpd) n√£o est√° instalado. Instalando..."
    sudo dnf install -y httpd
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå ERRO ao instalar o Apache. A sair.${NC}"
        exit 1
    fi
fi

# 2. Coleta informa√ß√µes de hardware e c√°lculo de MaxRequestWorkers
TOTAL_RAM_MB=$(free -m | awk '/^Mem:/{print $2}')
CPU_CORES=$(nproc)

echo -e "${BLUE}üßÆ Detectado: ${TOTAL_RAM_MB}MB RAM, ${CPU_CORES} CPU cores.${NC}"

# Define valores de tuning (ajustado para o ambiente de 2GB RAM / 2vCPUs)
if [[ $TOTAL_RAM_MB -lt 2000 ]]; then
    # Valor de refer√™ncia do relat√≥rio para hardware limitado
    MAX_WORKERS=150 
else
    # L√≥gica de c√°lculo se houver mais RAM dispon√≠vel
    MEM_PER_CHILD=50
    MAX_WORKERS=$((TOTAL_RAM_MB / MEM_PER_CHILD))
    if [[ $MAX_WORKERS -gt 512 ]]; then MAX_WORKERS=512; fi 
fi

START_SERVERS=2      
THREADS_PER_CHILD=25 
SERVER_LIMIT=$MAX_WORKERS

echo -e "${BLUE}üß© MaxRequestWorkers (total de threads) = ${MAX_WORKERS}${NC}"


# 3. Habilita m√≥dulos e desativa MPMs conflitantes
log_info "3. Ativa√ß√£o de M√≥dulos e Sele√ß√£o do MPM Event"

# Habilita m√≥dulos
sudo sed -i 's/^#\(LoadModule deflate_module modules\/mod_deflate.so\)/\1/' "$MODS_DIR"/*.conf
sudo sed -i 's/^#\(LoadModule headers_module modules\/mod_headers.so\)/\1/' "$MODS_DIR"/*.conf

# Garante que o MPM Event √© o √∫nico ativado (Desativa prefork/worker)
sudo sed -i 's/^LoadModule mpm_prefork_module/#&/' "$MODS_DIR"/*.conf
sudo sed -i 's/^LoadModule mpm_worker_module/#&/' "$MODS_DIR"/*.conf
sudo sed -i 's/^#LoadModule mpm_event_module/LoadModule mpm_event_module/' "$MODS_DIR"/*.conf
echo -e "${GREEN}‚úîÔ∏è M√≥dulos ativados e MPM Event selecionado.${NC}"


# 4. Aplica ajustes no httpd.conf (KeepAlive, Timeouts, Deflate)
log_info "4. Configura√ß√£o de KeepAlive, Timeouts e Deflate"

# Remove par√¢metros antigos e blocos de deflate antigos
sudo sed -i '/^Timeout/d' "$CONF_FILE"
sudo sed -i '/^KeepAlive/d' "$CONF_FILE"
sudo sed -i '/^MaxKeepAliveRequests/d' "$CONF_FILE"
sudo sed -i '/^KeepAliveTimeout/d' "$CONF_FILE"
sudo sed -i '/^<IfModule mod_deflate.c>/,/^<\/IfModule>/d' "$CONF_FILE" 

cat <<EOF | sudo tee -a "$CONF_FILE" > /dev/null

# ===================================================================
# üîß Tuning de performance Apache - $(date)
# ===================================================================

# Configura√ß√µes Gerais (Cap√≠tulo 6.3.2)
Timeout 60           
KeepAlive On         
KeepAliveTimeout 5   
MaxKeepAliveRequests 100

# Compress√£o GZIP (mod_deflate - Cap√≠tulo 6.3.1)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/javascript
    DeflateCompressionLevel 6
    Header append Vary User-Agent env=!dont-vary
</IfModule>
EOF


# 5. Configura√ß√£o do MPM Event no conf.modules.d
log_info "5. Ajuste dos Par√¢metros do MPM Event"

sudo sed -i '/<IfModule mpm_event_module>/,/<\/IfModule>/ {
    /StartServers/s/.*/    StartServers '"$START_SERVERS"'/
    /MinSpareThreads/s/.*/    MinSpareThreads 25/
    /MaxSpareThreads/s/.*/    MaxSpareThreads 75/
    /ThreadLimit/s/.*/    ThreadLimit 64/
    /ThreadsPerChild/s/.*/    ThreadsPerChild '"$THREADS_PER_CHILD"'/
    /MaxRequestWorkers/s/.*/    MaxRequestWorkers '"$MAX_WORKERS"'/
}' "$MPM_CONF"
echo -e "${GREEN}‚úîÔ∏è Par√¢metros do MPM Event ajustados.${NC}"


# 6. Reinicia o Apache
log_info "6. Rein√≠cio do Apache"
echo "üîÅ A reiniciar Apache..."
sudo systemctl enable httpd
sudo apachectl configtest
if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå ERRO FATAL: Falha na sintaxe da configura√ß√£o do Apache. Por favor, corrija antes de reiniciar.${NC}"
    exit 1
fi
sudo systemctl restart httpd

if systemctl is-active --quiet httpd; then
    echo -e "${GREEN}‚úÖ Apache otimizado e em execu√ß√£o!${NC}"
else
    echo -e "${RED}‚ùå Erro ao iniciar o Apache. Verifique o log.${NC}"
fi

echo -e "${GREEN}üéØ Tuning conclu√≠do!${NC}"


#!/bin/bash

# ============================================================
# Script 8 ‚Äî Tuning do MariaDB
# Objetivo: Ajustar par√¢metros de desempenho no /etc/my.cnf
# ============================================================

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}

log_ok() {
    echo -e "${GREEN}‚úî $1${NC}"
}

log_warn() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}

log_error() {
    echo -e "${RED}‚úñ $1${NC}"
}

# ============================================================
# 1. Verifica√ß√£o de depend√™ncias e permiss√µes
# ============================================================

if [ "$EUID" -ne 0 ]; then
    log_error "Execute este script como root."
    exit 1
fi

if ! command -v mysql &>/dev/null; then
    log_error "O MariaDB n√£o est√° instalado. Instale-o antes de continuar."
    exit 1
fi

# ============================================================
# 2. Calcular par√¢metros de tuning
# ============================================================

TOTAL_RAM=$(free -b | awk '/Mem:/ {print $2}')
BUFFER_POOL_SIZE=$(awk -v total="$TOTAL_RAM" 'BEGIN {printf "%d", total * 0.60}')
BUFFER_POOL_SIZE_MB=$((BUFFER_POOL_SIZE / 1024 / 1024))

log_info "Mem√≥ria total detectada: $(awk "BEGIN {print $TOTAL_RAM/1024/1024}") MB"
log_info "Definindo innodb_buffer_pool_size = ${BUFFER_POOL_SIZE_MB}M"

# ============================================================
# 3. Fazer backup do /etc/my.cnf
# ============================================================

if [ -f /etc/my.cnf ]; then
    BACKUP_FILE="/etc/my.cnf.bak_$(date +%F_%H-%M-%S)"
    cp /etc/my.cnf "$BACKUP_FILE"
    log_ok "Backup criado: $BACKUP_FILE"
else
    log_warn "/etc/my.cnf n√£o encontrado. Ser√° criado do zero."
fi

# ============================================================
# 4. Inserir/Atualizar par√¢metros de tuning
# ============================================================

log_info "Aplicando par√¢metros de tuning no /etc/my.cnf ..."

# Remove linhas antigas com os mesmos par√¢metros
sed -i '/innodb_buffer_pool_size/d' /etc/my.cnf 2>/dev/null
sed -i '/innodb_log_file_size/d' /etc/my.cnf 2>/dev/null
sed -i '/max_connections/d' /etc/my.cnf 2>/dev/null
sed -i '/query_cache_size/d' /etc/my.cnf 2>/dev/null

# Garante que a se√ß√£o [mysqld] exista
grep -q "^\[mysqld\]" /etc/my.cnf || echo -e "\n[mysqld]" >> /etc/my.cnf

# Adiciona as novas configura√ß√µes
cat <<EOF >> /etc/my.cnf

# ===== Ajustes autom√°ticos de desempenho =====
innodb_buffer_pool_size = ${BUFFER_POOL_SIZE_MB}M
innodb_log_file_size = 256M
max_connections = 100
query_cache_size = 32M
# =============================================
EOF

log_ok "Par√¢metros aplicados com sucesso ao /etc/my.cnf."

# ============================================================
# 5. Reiniciar o servi√ßo MariaDB
# ============================================================

log_info "Reiniciando o servi√ßo MariaDB..."
systemctl restart mariadb || systemctl restart mysql

if systemctl is-active --quiet mariadb || systemctl is-active --quiet mysql; then
    log_ok "MariaDB reiniciado com sucesso."
else
    log_error "Falha ao reiniciar o MariaDB. Verifique o log do sistema."
    exit 1
fi

# ============================================================
# 6. Valida√ß√£o do desempenho
# ============================================================

log_info "Validando par√¢metros aplicados no servidor MariaDB..."

mysql -e "SHOW VARIABLES LIKE 'innodb_buffer_pool_size';"
mysql -e "SHOW VARIABLES LIKE 'innodb_log_file_size';"
mysql -e "SHOW VARIABLES LIKE 'max_connections';"
mysql -e "SHOW VARIABLES LIKE 'query_cache_size';"

echo
log_ok "Tuning do MariaDB conclu√≠do com sucesso!"
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}Par√¢metros atualizados e servi√ßo validado com sucesso.${NC}"
echo -e "${GREEN}=====================================================${NC}"



#!/bin/bash

# ============================================================
# Script 9 ‚Äî Ajustes PHP
# Objetivo: Aplicar configura√ß√µes de desempenho e ambiente no /etc/php.ini
# ============================================================

# Cores
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}--- $1 ---${NC}"
}
log_ok() {
    echo -e "${GREEN}‚úî $1${NC}"
}
log_warn() {
    echo -e "${YELLOW}‚ö† $1${NC}"
}
log_error() {
    echo -e "${RED}‚úñ $1${NC}"
}

# ============================================================
# 1. Verifica√ß√£o de permiss√µes e depend√™ncias
# ============================================================

if [ "$EUID" -ne 0 ]; then
    log_error "Execute este script como root."
    exit 1
fi

PHP_INI="/etc/php.ini"

if [ ! -f "$PHP_INI" ]; then
    log_error "Arquivo $PHP_INI n√£o encontrado. Verifique a instala√ß√£o do PHP."
    exit 1
fi

# ============================================================
# 2. Fazer backup do php.ini
# ============================================================

BACKUP_FILE="${PHP_INI}.bak_$(date +%F_%H-%M-%S)"
cp "$PHP_INI" "$BACKUP_FILE"
log_ok "Backup criado: $BACKUP_FILE"

# ============================================================
# 3. Aplicar as configura√ß√µes solicitadas
# ============================================================

log_info "Aplicando configura√ß√µes no $PHP_INI ..."

# Remove linhas antigas e substitui por novas configura√ß√µes
sed -i '/^date.timezone/d' "$PHP_INI"
sed -i '/^upload_max_filesize/d' "$PHP_INI"
sed -i '/^post_max_size/d' "$PHP_INI"
sed -i '/^memory_limit/d' "$PHP_INI"

cat <<EOF >> "$PHP_INI"

; ===== Ajustes autom√°ticos de configura√ß√£o =====
date.timezone = Europe/Lisbon
upload_max_filesize = 20M
post_max_size = 25M
memory_limit = 256M
; ===============================================
EOF

log_ok "Configura√ß√µes aplicadas com sucesso."

# ============================================================
# 4. Reiniciar o servi√ßo PHP (detec√ß√£o autom√°tica)
# ============================================================

log_info "Reiniciando o servi√ßo PHP..."

if systemctl list-units --type=service | grep -q "php-fpm"; then
    systemctl restart php-fpm && log_ok "Servi√ßo php-fpm reiniciado."
elif systemctl list-units --type=service | grep -q "apache2"; then
    systemctl restart apache2 && log_ok "Servi√ßo Apache reiniciado."
elif systemctl list-units --type=service | grep -q "httpd"; then
    systemctl restart httpd && log_ok "Servi√ßo httpd reiniciado."
else
    log_warn "Nenhum servi√ßo PHP-FPM ou Apache detectado. Reinicie manualmente se necess√°rio."
fi

# ============================================================
# 5. Valida√ß√£o das configura√ß√µes
# ============================================================

log_info "Validando configura√ß√µes aplicadas..."
grep -E "date.timezone|upload_max_filesize|post_max_size|memory_limit" "$PHP_INI"

echo
log_ok "Ajustes PHP conclu√≠dos com sucesso!"
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}Par√¢metros atualizados e servi√ßo verificado.${NC}"
echo -e "${GREEN}=====================================================${NC}"




#!/bin/bash
# ============================================================
# Script 10 ‚Äî Atualiza√ß√µes e Backup
# ============================================================
# Fun√ß√µes:
#  1. Executa atualiza√ß√µes autom√°ticas do sistema (dnf update -y)
#  2. Cria backups di√°rios de:
#     - /var/www/html
#     - Bases de dados MariaDB
#  3. Comprime e envia para /backups ou servidor remoto via SCP
# ============================================================

# ---- Cores ----
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info()  { echo -e "${BLUE}--- $1 ---${NC}"; }
log_ok()    { echo -e "${GREEN}‚úî $1${NC}"; }
log_warn()  { echo -e "${YELLOW}‚ö† $1${NC}"; }
log_error() { echo -e "${RED}‚úñ $1${NC}"; }

# ============================================================
# 1. Valida√ß√£o inicial
# ============================================================

if [ "$EUID" -ne 0 ]; then
    log_error "Execute este script como root."
    exit 1
fi

BACKUP_DIR="/backups"
DATA=$(date +%F)
BACKUP_TEMP="/tmp/backup_${DATA}"
mkdir -p "$BACKUP_DIR" "$BACKUP_TEMP"

# ============================================================
# 2. Atualiza√ß√µes do sistema
# ============================================================

log_info "Atualizando pacotes do sistema..."
dnf clean all -q
dnf update -y
if [ $? -eq 0 ]; then
    log_ok "Sistema atualizado com sucesso."
else
    log_warn "Algumas atualiza√ß√µes falharam. Verifique manualmente."
fi

# ============================================================
# 3. Backup de /var/www/html
# ============================================================

log_info "Criando backup dos ficheiros web (/var/www/html)..."

if [ -d "/var/www/html" ]; then
    tar -czf "${BACKUP_TEMP}/html_${DATA}.tar.gz" /var/www/html 2>/dev/null
    log_ok "Backup de /var/www/html conclu√≠do."
else
    log_warn "/var/www/html n√£o encontrado, a ignorar..."
fi

# ============================================================
# 4. Backup das bases de dados MariaDB
# ============================================================

log_info "Gerando backup das bases de dados MariaDB..."

if systemctl is-active mariadb &>/dev/null; then
    mkdir -p "${BACKUP_TEMP}/db"
    DB_USER="root"

    read -s -p "Digite a password do utilizador MariaDB ($DB_USER): " DB_PASS
    echo

    DATABASES=$(mysql -u"$DB_USER" -p"$DB_PASS" -e "SHOW DATABASES;" | grep -Ev "(Database|information_schema|performance_schema)")
    for DB in $DATABASES; do
        mysqldump -u"$DB_USER" -p"$DB_PASS" "$DB" > "${BACKUP_TEMP}/db/${DB}_${DATA}.sql"
    done

    tar -czf "${BACKUP_TEMP}/mariadb_${DATA}.tar.gz" -C "${BACKUP_TEMP}/db" .
    rm -rf "${BACKUP_TEMP}/db"
    log_ok "Backup das bases de dados conclu√≠do."
else
    log_warn "Servi√ßo MariaDB n√£o est√° ativo. Nenhum backup de BD criado."
fi

# ============================================================
# 5. Compress√£o final
# ============================================================

FINAL_FILE="${BACKUP_DIR}/backup_completo_${DATA}.tar.gz"

log_info "Comprimindo todos os backups em ${FINAL_FILE} ..."
tar -czf "$FINAL_FILE" -C "$BACKUP_TEMP" .
rm -rf "$BACKUP_TEMP"
log_ok "Backup completo gerado com sucesso."

# ============================================================
# 6. Envio opcional via SCP
# ============================================================

read -p "Deseja enviar o backup para um servidor remoto via SCP? (s/n): " RESPOSTA
if [[ "$RESPOSTA" =~ ^[Ss]$ ]]; then
    read -p "Endere√ßo do servidor remoto (ex: user@host): " REMOTE_USERHOST
    read -p "Diret√≥rio remoto (ex: /home/user/backups): " REMOTE_DIR
    scp "$FINAL_FILE" "${REMOTE_USERHOST}:${REMOTE_DIR}"
    if [ $? -eq 0 ]; then
        log_ok "Backup enviado com sucesso para ${REMOTE_USERHOST}:${REMOTE_DIR}"
    else
        log_error "Falha ao enviar o backup via SCP."
    fi
else
    log_info "Backup armazenado localmente em ${BACKUP_DIR}"
fi

# ============================================================
# 7. Conclus√£o
# ============================================================

echo
log_ok "Processo conclu√≠do!"
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}Atualiza√ß√µes e backups executados com sucesso!${NC}"
echo -e "${GREEN}=====================================================${NC}"


#!/bin/bash

# ======================================================
# Script 11 de Monitoriza√ß√£o Interativo - CentOS 9/10
# ======================================================

# ------------------------------------------------------
# Pergunta interativa pelo email
# ------------------------------------------------------
read -p "Digite o email para receber alertas: " EMAIL_ALERTA
if [ -z "$EMAIL_ALERTA" ]; then
    echo "Erro: Nenhum email fornecido. Encerrando script."
    exit 1
fi

# ------------------------------------------------------
# Pergunta quais servi√ßos monitorar
# ------------------------------------------------------
echo "Quais servi√ßos deseja monitorar?"
echo "1) Apache"
echo "2) MariaDB"
echo "3) PHP-FPM"
echo "4) Todos os servi√ßos acima"
read -p "Escolha uma op√ß√£o (1-4): " OPCAO_SERVICOS

SERVICOS=()
LOGS=()

case "$OPCAO_SERVICOS" in
    1)
        SERVICOS=("httpd")
        LOGS=("/var/log/httpd/*.log")
        ;;
    2)
        SERVICOS=("mariadb")
        LOGS=("/var/log/mariadb/mariadb.log")
        ;;
    3)
        SERVICOS=("php-fpm")
        LOGS=("/var/log/php-fpm/error.log")
        ;;
    4)
        SERVICOS=("httpd" "mariadb" "php-fpm")
        LOGS=("/var/log/httpd/*.log" "/var/log/secure" "/var/log/mariadb/mariadb.log" "/var/log/php-fpm/error.log")
        ;;
    *)
        echo "Op√ß√£o inv√°lida. Encerrando."
        exit 1
        ;;
esac

PATTERN="error"
LOG_ALERTS="/var/log/monitor_alerts.log"

echo "Iniciando monitoriza√ß√£o em $(date '+%d %b %Y %T %Z')..."

# ------------------------------------------------------
# Fun√ß√£o de envio de alerta por email
# ------------------------------------------------------
enviar_alerta() {
    local MSG="$1"
    local SUBJECT="$2"

    if ! command -v sendmail &> /dev/null; then
        echo "Nenhum MTA ativo. Instalando postfix..."
        yum install -y postfix
        systemctl enable --now postfix
    fi

    echo "$MSG" | sendmail -t "$EMAIL_ALERTA" -s "$SUBJECT"
   echo "$(date '+%Y-%m-%d %H:%M:%S') - $SUBJECT - $MSG" >> "$LOG_ALERTS"
}

# ------------------------------------------------------
# Fun√ß√£o de monitoriza√ß√£o de logs
# ------------------------------------------------------
monitorar_logs() {
    local ARQUIVOS="$1"
    local SERVICO="$2"

    for LOG in $ARQUIVOS; do
        if [ -f "$LOG" ]; then
            grep -i "$PATTERN" "$LOG" | while read -r LINHA; do
                if ! grep -Fq "$LINHA" "$LOG_ALERTS" 2>/dev/null; then
                    MSG="Alerta de seguran√ßa: Padr√£o '$PATTERN' encontrado em $LOG -> $LINHA"
                    enviar_alerta "$MSG" "Alerta $SERVICO"
                fi
            done
        fi
    done
}

# ------------------------------------------------------
# Monitoriza√ß√£o principal
# ------------------------------------------------------
for i in "${!SERVICOS[@]}"; do
    monitorar_logs "${LOGS[$i]}" "${SERVICOS[$i]}"
done

# ------------------------------------------------------
# Verifica√ß√£o de servi√ßos ativos
# ------------------------------------------------------
verificar_servico() {
    local SERVICO="$1"
    if ! systemctl is-active --quiet "$SERVICO"; then
        MSG="Alerta: Servi√ßo $SERVICO n√£o est√° ativo em $(date)"
        enviar_alerta "$MSG" "Falha Servi√ßo: $SERVICO"
    fi
}

for SVC in "${SERVICOS[@]}"; do
    verificar_servico "$SVC"
done

# ------------------------------------------------------
# Sincroniza√ß√£o hor√°ria via Chrony
# ------------------------------------------------------
if command -v chronyd &> /dev/null; then
    echo "Sincronizando hor√°rio via Chrony..."
    chronyc -a makestep
    systemctl enable --now chronyd
else
    echo "Pacote chrony n√£o encontrado. Instalando chrony..."
    yum install -y chrony
    chronyc -a makestep
    systemctl enable --now chronyd
fi

# ------------------------------------------------------
# Configura√ß√£o b√°sica de logrotate
# ------------------------------------------------------
if [ ! -f /etc/logrotate.d/lamp ]; then
    echo "Criando configura√ß√£o de logrotate para Apache e PHP..."
    cat << EOF > /etc/logrotate.d/lamp
/var/log/httpd/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
    postrotate
        /bin/systemctl reload httpd > /dev/null 2>/dev/null || true
    endscript
}

/var/log/php-fpm/error.log {
    weekly
    rotate 4
    compress
    missingok
    notifempty
    postrotate
        /bin/systemctl reload php-fpm > /dev/null 2>/dev/null || true
    endscript
}
EOF
fi

echo "Monitoriza√ß√£o conclu√≠da em $(date '+%d %b %Y %T %Z')"



#!/bin/bash

# =================================================================
# Script: Apache HTTPS + SSL + DuckDNS (IPv4 & IPv6, fallback)
# =================================================================

# Cores
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}--- $1 ---${NC}"; }

echo -e "${YELLOW}--- Iniciando configura√ß√£o Apache + HTTPS + DuckDNS ---${NC}"

# =================================================================
# 1. Solicitar dados do usu√°rio
# =================================================================
log_info "1. Informa√ß√µes do usu√°rio"
read -p "Digite o seu subdom√≠nio DuckDNS (ex: sabormar): " DUCK_DOMAIN
read -p "Digite o seu token DuckDNS: " DUCK_TOKEN
read -p "Digite um e-mail para Let‚Äôs Encrypt/Apache: " SERVER_EMAIL

APACHE_DOMAIN="${DUCK_DOMAIN}.duckdns.org"
DUCK_DIR="/root/duckdns"
DUCK_SCRIPT="${DUCK_DIR}/duck.sh"
DUCK_LOG="${DUCK_DIR}/duck.log"

echo -e "${GREEN}‚úÖ Dom√≠nio configurado: ${APACHE_DOMAIN}${NC}"
echo "--------------------------------------------------------"

# =================================================================
# 2. Detectar IPs p√∫blicos
# =================================================================
log_info "2. Detectando IPs p√∫blicos"
IPV4=$(curl -4 -s ifconfig.me)
IPV6=$(curl -6 -s ifconfig.co || echo "")

echo "IPv4 detectado: $IPV4"
if [ -n "$IPV6" ]; then
    echo "IPv6 detectado: $IPV6"
else
    echo "‚ö†Ô∏è Nenhum IPv6 detectado"
fi
echo "--------------------------------------------------------"

# =================================================================
# 3. Configura√ß√£o VirtualHosts tempor√°rios
# =================================================================
log_info "3. Criando VirtualHosts Apache tempor√°rios"

HTTP_CONF="/etc/httpd/conf.d/vhost_http_${DUCK_DOMAIN}.conf"
SSL_CONF="/etc/httpd/conf.d/vhost_ssl_${DUCK_DOMAIN}.conf"
TEMP_CERT_DIR="/etc/pki/tls"

sudo mkdir -p "${TEMP_CERT_DIR}/certs" "${TEMP_CERT_DIR}/private"

# Certificado tempor√°rio self-signed
sudo openssl req -x509 -nodes -days 1 \
  -newkey rsa:2048 \
  -keyout "${TEMP_CERT_DIR}/private/localhost.key" \
  -out "${TEMP_CERT_DIR}/certs/localhost.crt" \
  -subj "/C=PT/ST=Lisboa/L=Lisboa/O=${DUCK_DOMAIN}/OU=IT/CN=localhost"

# VirtualHost HTTP
sudo bash -c "cat > ${HTTP_CONF}" <<EOF_HTTP
<VirtualHost *:80>
    ServerName ${APACHE_DOMAIN}
    DocumentRoot /var/www/html
    Redirect permanent / https://${APACHE_DOMAIN}/
</VirtualHost>
EOF_HTTP

# VirtualHost HTTPS tempor√°rio
sudo bash -c "cat > ${SSL_CONF}" <<EOF_SSL
<VirtualHost *:443>
    ServerName ${APACHE_DOMAIN}
    ServerAdmin ${SERVER_EMAIL}
    DocumentRoot "/var/www/html"

    ErrorLog logs/${DUCK_DOMAIN}_ssl_error.log
    CustomLog logs/${DUCK_DOMAIN}_ssl_access.log combined

    <Directory "/var/www/html">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    SSLEngine on
    SSLCertificateFile ${TEMP_CERT_DIR}/certs/localhost.crt
    SSLCertificateKeyFile ${TEMP_CERT_DIR}/private/localhost.key

    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite HIGH:!aNULL:!MD5
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
</VirtualHost>
EOF_SSL

echo -e "${GREEN}‚úîÔ∏è VirtualHosts tempor√°rios criados${NC}"
echo "--------------------------------------------------------"

# =================================================================
# 4. Instalar Apache, mod_ssl e Certbot
# =================================================================
log_info "4. Instalando pacotes Apache/SSL/Certbot"
sudo dnf install epel-release -y
sudo dnf install httpd mod_ssl openssl certbot python3-certbot-apache -y

if ! command -v certbot &>/dev/null; then
    echo "‚ö†Ô∏è Certbot n√£o encontrado, instalando via Snap..."
    sudo dnf install snapd -y
    sudo systemctl enable --now snapd.socket
    sudo snap install core
    sudo snap refresh core
    sudo snap install --classic certbot
    sudo ln -s /snap/bin/certbot /usr/bin/certbot
fi
echo -e "${GREEN}‚úîÔ∏è Pacotes instalados${NC}"
echo "--------------------------------------------------------"

# =================================================================
# 5. Configura√ß√£o do firewall
# =================================================================
log_info "5. Abrir portas 80 e 443"
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
echo -e "${GREEN}‚úîÔ∏è Firewall configurado${NC}"
echo "--------------------------------------------------------"

# =================================================================
# 6. Reiniciar Apache
# =================================================================
log_info "6. Reiniciar Apache"
sudo apachectl configtest
sudo systemctl restart httpd
sudo systemctl enable httpd
echo -e "${GREEN}‚úîÔ∏è Apache reiniciado${NC}"
echo "--------------------------------------------------------"

# =================================================================
# 7. Configura√ß√£o DuckDNS
# =================================================================
log_info "7. Configura√ß√£o DuckDNS"
sudo mkdir -p "$DUCK_DIR" && sudo chmod 700 "$DUCK_DIR"

sudo bash -c "cat > ${DUCK_SCRIPT}" <<EOF
#!/bin/bash
URL="https://www.duckdns.org/update?domains=${DUCK_DOMAIN}&token=${DUCK_TOKEN}&ip=${IPV4}"
EOF

if [ -n "$IPV6" ]; then
    sudo bash -c "echo 'URL=\"\${URL}&ipv6=${IPV6}\"' >> ${DUCK_SCRIPT}"
fi

sudo bash -c "cat >> ${DUCK_SCRIPT}" <<'EOF2'
echo url="${URL}" | curl -k -o /root/duckdns/duck.log -K -
DATE=$(date)
echo "$DATE - Atualiza√ß√£o executada" >> /root/duckdns/duck.log
EOF2

sudo chmod 700 "$DUCK_SCRIPT"

# Cron autom√°tico
(sudo crontab -l 2>/dev/null; echo "*/5 * * * * ${DUCK_SCRIPT} >/dev/null 2>&1") | sudo crontab -

# Teste inicial
sudo bash "$DUCK_SCRIPT"
if grep -q "OK" "$DUCK_LOG" 2>/dev/null; then
    echo -e "${GREEN}‚úîÔ∏è DuckDNS atualizado com sucesso${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è Verifique ${DUCK_LOG}${NC}"
fi
echo "--------------------------------------------------------"

# =================================================================
# 8. Emitir certificado Let‚Äôs Encrypt com fallback
# =================================================================
log_info "8. Emitir certificado Let‚Äôs Encrypt"

LE_DIR="/etc/letsencrypt/live/${APACHE_DOMAIN}"
ISSUED=false

# Tentativa 1: Apache plugin
if certbot --apache -d "$APACHE_DOMAIN" --non-interactive --agree-tos -m "$SERVER_EMAIL"; then
    echo -e "${GREEN}‚úîÔ∏è Certificado emitido com Apache plugin${NC}"
    ISSUED=true
else
    echo -e "${YELLOW}‚ö†Ô∏è Apache plugin falhou. Tentando Standalone...${NC}"
    sudo systemctl stop httpd
    if certbot certonly --standalone -d "$APACHE_DOMAIN" --non-interactive --agree-tos -m "$SERVER_EMAIL"; then
        echo -e "${GREEN}‚úîÔ∏è Certificado emitido com Standalone${NC}"
        ISSUED=true
    else
        echo -e "${RED}‚ùå Falha ao emitir certificado Let‚Äôs Encrypt${NC}"
    fi
    sudo systemctl start httpd
fi

echo -e "\n${YELLOW}--- ‚úÖ Script conclu√≠do. DuckDNS + Apache + SSL/Let‚Äôs Encrypt configurado ---${NC}"

